using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using ChilliCream.Testing;
using HotChocolate.Execution.Utilities;
using HotChocolate.Language;
using HotChocolate.StarWars;
using HotChocolate.Types;
using HotChocolate.Utilities;
using Moq;
using Snapshooter.Xunit;
using Xunit;

namespace HotChocolate.Execution
{
    public class FieldCollectorTests
    {
        [Fact]
        public void MergeFieldsWithFragmentSpreads()
        {
            // arrange
            DocumentNode query = Utf8GraphQLParser.Parse(
                FileResource.Open("MergeQuery.graphql"));

            OperationDefinitionNode operation =
                query.Definitions.OfType<OperationDefinitionNode>().Single();

            var schema = Schema.Create(
                FileResource.Open("MergeSchema.graphql"),
                c => c.Use(next => context => Task.CompletedTask));

            var fragments = new FragmentCollection(schema, query);

            var variables = new VariableValueCollection(
                TypeConversion.Default,
                new Dictionary<string, VariableValue>());

            // act
            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> selections =
                collector.CollectFields(schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            // assert
            Assert.Collection(selections,
                selection =>
                {
                    Assert.Collection(selection.Selection.SelectionSet.Selections,
                        selectionNode =>
                        {
                            FragmentSpreadNode fragment = Assert.IsType<FragmentSpreadNode>(
                                selectionNode);
                            Assert.Equal("app", fragment.Name.Value);
                        },
                        selectionNode =>
                        {
                            FragmentSpreadNode fragment = Assert.IsType<FragmentSpreadNode>(
                                selectionNode);
                            Assert.Equal("parts", fragment.Name.Value);
                        });
                });
        }

        [Fact]
        public void MergeMerged()
        {
            // arrange
            DocumentNode query = Utf8GraphQLParser.Parse(
                FileResource.Open("MergeQuery.graphql"));

            OperationDefinitionNode operation =
                query.Definitions.OfType<OperationDefinitionNode>().Single();

            var schema = Schema.Create(
                FileResource.Open("MergeSchema.graphql"),
                c => c.Use(next => context => Task.CompletedTask));

            var fragments = new FragmentCollection(schema, query);

            var variables = new VariableValueCollection(
                TypeConversion.Default,
                new Dictionary<string, VariableValue>());

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> selections =
                collector.CollectFields(schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            // act
            selections = collector.CollectFields(
                schema.GetType<ObjectType>("Application"),
                selections.Single().Selection.SelectionSet,
                Path.New("bat"));

            // assert
            Assert.Collection(selections,
                selection => Assert.Equal("id", selection.ResponseName),
                selection => Assert.Equal("name", selection.ResponseName),
                selection => Assert.Equal("parts", selection.ResponseName));
        }

        [Fact]
        public void Coerce_NonNullString_ToAbc()
        {
            // arrange
            DocumentNode document =
                Utf8GraphQLParser.Parse("{ bar (a: \"abc\") }");
            OperationDefinitionNode operation = document.Definitions
                .OfType<OperationDefinitionNode>().First();

            ISchema schema = CreateSchema();
            var fragments = new FragmentCollection(
                schema,
                document);

            var variables = new VariableValueCollection(
                TypeConversion.Default,
                new Dictionary<string, VariableValue>());

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> selections =
                collector.CollectFields(schema.QueryType,
                    operation.SelectionSet, Path.New("bar"));
            FieldSelection selection = selections.First();
            var path = Path.New("bar");

            // act
            IReadOnlyDictionary<NameString, ArgumentValue> arguments =
                selection.CoerceArguments(variables, TypeConversion.Default);

            // assert
            MatchSnapshot(arguments);
        }

        [Fact]
        public void Coerce_NonNullString_ToNull()
        {
            // arrange
            DocumentNode document =
               Utf8GraphQLParser.Parse("{ bar }");
            OperationDefinitionNode operation = document.Definitions
                .OfType<OperationDefinitionNode>().First();

            ISchema schema = CreateSchema();
            var fragments = new FragmentCollection(
                schema,
                document);

            var variables = new VariableValueCollection(
                TypeConversion.Default,
                new Dictionary<string, VariableValue>());

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> selections =
                collector.CollectFields(schema.QueryType,
                    operation.SelectionSet, Path.New("bar"));
            FieldSelection selection = selections.First();
            var path = Path.New("bar");

            // act
            Action action = () =>
                selection.CoerceArguments(variables, TypeConversion.Default);

            // assert
            Assert.Throws<QueryException>(action).Errors.MatchSnapshot();
        }

        [Fact]
        public void Coerce_InputObject_NonNullFieldIsNull()
        {
            // arrange
            DocumentNode document =
                Utf8GraphQLParser.Parse("{ foo(a: {  a: { } }) }");
            OperationDefinitionNode operation = document.Definitions
                .OfType<OperationDefinitionNode>().First();

            ISchema schema = CreateSchema();
            var fragments = new FragmentCollection(
                schema,
                document);

            var variables = new VariableValueCollection(
                TypeConversion.Default,
                new Dictionary<string, VariableValue>());

            var collector = new FieldCollector(
                fragments, (f, s) => null, TypeConversion.Default);
            IReadOnlyCollection<FieldSelection> selections =
                collector.CollectFields(schema.QueryType,
                    operation.SelectionSet, null);
            FieldSelection selection = selections.First();

            // act
            Action action = () =>
                selection.CoerceArguments(variables, TypeConversion.Default);

            // assert
            Assert.Throws<QueryException>(action).Errors.MatchSnapshot();
        }

        [Fact]
        public void Field_Is_Visible_When_One_Selection_Is_Visible_1()
        {
            // arrange
            var variables = new Mock<IVariableValueCollection>();
            variables.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>())).Returns(false);

            DocumentNode document = Utf8GraphQLParser.Parse(
                @"query foo($v: Boolean){
                    hero(episode: EMPIRE) {
                        name
                        ... abc @include(if: $v)
                    }
                }
                fragment abc on Droid {
                    name
                }");

            OperationDefinitionNode operation =
                document.Definitions.OfType<OperationDefinitionNode>().Single();

            ISchema schema = SchemaBuilder.New()
                .AddStarWarsTypes()
                .Create();

            ObjectType droid = schema.GetType<ObjectType>("Droid");

            var fragments = new FragmentCollection(schema, document);

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> rootSelections =
                collector.CollectFields(
                    schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            FieldSelection hero = rootSelections.Single();

            // act
            IReadOnlyList<FieldSelection> droidSelections =
                collector.CollectFields(
                    droid,
                    hero.Selection.SelectionSet,
                    Path.New("foo").Append(hero.ResponseName));

            // assert
            Assert.Equal("name", droidSelections[0].ResponseName);
            Assert.Equal(true, droidSelections[0].IsVisible(variables.Object));
        }

        [Fact]
        public void Field_Is_Visible_When_One_Selection_Is_Visible_2()
        {
            // arrange
            var variables = new Mock<IVariableValueCollection>();
            variables.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>())).Returns(false);

            DocumentNode document = Utf8GraphQLParser.Parse(
                @"query foo($v: Boolean){
                    hero(episode: EMPIRE) {
                        name @include(if: $v)
                        ... abc
                    }
                }
                fragment abc on Droid {
                    name
                }");

            OperationDefinitionNode operation =
                document.Definitions.OfType<OperationDefinitionNode>().Single();

            ISchema schema = SchemaBuilder.New()
                .AddStarWarsTypes()
                .Create();

            ObjectType droid = schema.GetType<ObjectType>("Droid");

            var fragments = new FragmentCollection(schema, document);

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> rootSelections =
                collector.CollectFields(
                    schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            FieldSelection hero = rootSelections.Single();

            // act
            IReadOnlyList<FieldSelection> droidSelections =
                collector.CollectFields(
                    droid,
                    hero.Selection.SelectionSet,
                    Path.New("foo").Append(hero.ResponseName));

            // assert
            Assert.Equal("name", droidSelections[0].ResponseName);
            Assert.Equal(true, droidSelections[0].IsVisible(variables.Object));
        }

        [Fact]
        public void Field_Is_Visible_When_One_Selection_Is_Visible_3()
        {
            // arrange
            var variables = new Mock<IVariableValueCollection>();
            variables.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>()))
                .Returns((NameString name) =>
                {
                    return name.Equals("q");
                });

            DocumentNode document = Utf8GraphQLParser.Parse(
                @"query foo($v: Boolean, $q: Boolean){
                    hero(episode: EMPIRE) {
                        name @include(if: $v)
                        ... abc @include(if: $q)
                    }
                }
                fragment abc on Droid {
                    name
                }");

            OperationDefinitionNode operation =
                document.Definitions.OfType<OperationDefinitionNode>().Single();

            ISchema schema = SchemaBuilder.New()
                .AddStarWarsTypes()
                .Create();

            ObjectType droid = schema.GetType<ObjectType>("Droid");

            var fragments = new FragmentCollection(schema, document);

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> rootSelections =
                collector.CollectFields(
                    schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            FieldSelection hero = rootSelections.Single();

            // act
            IReadOnlyList<FieldSelection> droidSelections =
                collector.CollectFields(
                    droid,
                    hero.Selection.SelectionSet,
                    Path.New("foo").Append(hero.ResponseName));

            // assert
            Assert.Equal("name", droidSelections[0].ResponseName);
            Assert.Equal(false, droidSelections[0].IsVisible(variables.Object));
        }

        [Fact]
        public void Field_Is_Visible_When_One_Selection_Is_Visible_4()
        {
            // arrange
            var variables = new Mock<IVariableValueCollection>();
            variables.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>())).Returns(false);

            DocumentNode document = Utf8GraphQLParser.Parse(
                @"query foo($v: Boolean){
                    hero(episode: EMPIRE) {
                        name @include(if: $v)
                        ... abc
                    }
                }
                fragment abc on Droid {
                    name
                    ... {
                        name
                    }
                }");

            OperationDefinitionNode operation =
                document.Definitions.OfType<OperationDefinitionNode>().Single();

            ISchema schema = SchemaBuilder.New()
                .AddStarWarsTypes()
                .Create();

            ObjectType droid = schema.GetType<ObjectType>("Droid");

            var fragments = new FragmentCollection(schema, document);

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> rootSelections =
                collector.CollectFields(
                    schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            FieldSelection hero = rootSelections.Single();

            // act
            IReadOnlyList<FieldSelection> droidSelections =
                collector.CollectFields(
                    droid,
                    hero.Selection.SelectionSet,
                    Path.New("foo").Append(hero.ResponseName));

            // assert
            Assert.Equal("name", droidSelections[0].ResponseName);
            Assert.Equal(true, droidSelections[0].IsVisible(variables.Object));
        }

        [Fact]
        public void Object_Field_Visibility_Is_Correctly_Inherited()
        {
            // arrange
            var vFalse = new Mock<IVariableValueCollection>();
            vFalse.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>())).Returns(false);

            var vTrue = new Mock<IVariableValueCollection>();
            vTrue.Setup(t => t.GetVariable<bool>(It.IsAny<NameString>())).Returns(true);

            DocumentNode document = Utf8GraphQLParser.Parse(
                @"query foo($v: Boolean) {
                    hero(episode: EMPIRE) @include(if: $v) {
                        name
                    }
                    ... on Query {
                        hero(episode: EMPIRE) {
                            id
                        }
                    }
                    ... @include(if: $v) {
                        hero(episode: EMPIRE) {
                            height
                        }
                    }
                }");

            OperationDefinitionNode operation =
                document.Definitions.OfType<OperationDefinitionNode>().Single();

            ISchema schema = SchemaBuilder.New()
                .AddStarWarsTypes()
                .Create();

            ObjectType droid = schema.GetType<ObjectType>("Droid");

            var fragments = new FragmentCollection(schema, document);

            var collector = new FieldCollector(
                fragments,
                (f, s) => null,
                TypeConversion.Default);

            IReadOnlyCollection<FieldSelection> rootSelections =
                collector.CollectFields(
                    schema.QueryType,
                    operation.SelectionSet, Path.New("foo"));

            FieldSelection hero = rootSelections.Single();

            // act
            IReadOnlyList<FieldSelection> droidSelections =
                collector.CollectFields(
                    droid,
                    hero.Selection.SelectionSet,
                    Path.New("foo").Append(hero.ResponseName));

            // assert
            Assert.Collection(
                droidSelections.Where(t => t.IsVisible(vFalse.Object)),
                t => Assert.Equal("id", t.ResponseName));

            Assert.Collection(
                droidSelections.Where(t => t.IsVisible(vTrue.Object)),
                t => Assert.Equal("name", t.ResponseName),
                t => Assert.Equal("id", t.ResponseName),
                t => Assert.Equal("height", t.ResponseName));
        }

        private static ISchema CreateSchema()
        {
            return Schema.Create(
                FileResource.Open("ArgumentValueBuilder.graphql"),
                c => c.Use(next => context => Task.CompletedTask));
        }

        private static FieldNode CreateField(string field)
        {
            return Utf8GraphQLParser.Parse($"{{ {field} }}").Definitions
                .OfType<OperationDefinitionNode>()
                .SelectMany(t => t.SelectionSet.Selections)
                .OfType<FieldNode>()
                .First();
        }

        private void MatchSnapshot(
            IReadOnlyDictionary<NameString, PreparedArgument> args)
        {
            args.Select(t => new ArgumentValueSnapshot(t.Key, t.Value))
                .ToList().MatchSnapshot();
        }

        private class ArgumentValueSnapshot
        {
            public ArgumentValueSnapshot(
                string name,
                PreparedArgument argumentValue)
            {
                Name = name;
                Type = TypeVisualizer.Visualize(argumentValue.Type);
                Value = argumentValue.Value;
            }

            public string Name { get; }

            public string Type { get; }

            public object Value { get; }
        }
    }
}
